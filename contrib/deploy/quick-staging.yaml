---
# prepare docker and images for webservers:
- name: build the code
  hosts: vagrant

  tasks:
    - name: clean all data
      make:
        target: clean
        chdir: /home/develop/gad

    - name: build binaries
      make:
        target: all
        chdir: /home/develop/gad

# copy builded go app to webservers:
- name: copy builded GO app to webservers and run
  hosts: staging
  tasks:

    - name: copy go binary files to web servers
      synchronize:
        src: "{{ playbook_dir }}/../../bin/"
        dest: "/home/cy/gad/bin/"
        delete: yes
        rsync_opts: "--exclude=.git --exclude=*.sh --exclude=gb* --exclude=go-bindata --exclude=fswatch --exclude=codegen --exclude=.gitignore"
        checksum: yes
        times: no

    - name: sync the clcikyab-old code
      synchronize:
        src: "{{ playbook_dir }}/../../clickyab-server/"
        dest: "/home/cy/gad/clickyab-server/"
        delete: yes
        rsync_opts: "--exclude=.git --exclude=gb* --exclude=go-bindata --exclude=fswatch --exclude=codegen --exclude=.gitignore"
        checksum: yes
        times: no

- name: Run web server
  hosts: web
  tasks:

    - name: Re-create a web container
      docker_container:
        name: gad-web
        image: registry.clickyab.ae/clickyab/gad-runner
        command: /app/bin/server
        state: started
        restart_policy: always
        recreate: yes
        ports:
          - 80:80
        volumes:
          - /home/cy/gad:/app

- name: Run click worker
  hosts: click
  tasks:

    - name: Re-create a click container
      docker_container:
        name: gad-click
        image: registry.clickyab.ae/clickyab/gad-runner
        command: /app/bin/clickworker
        state: started
        restart_policy: always
        recreate: yes
        volumes:
          - /home/cy/gad:/app

- name: Run imp worker
  hosts: imp
  tasks:

    - name: Re-create a imp worker
      docker_container:
        name: gad-imp
        image: registry.clickyab.ae/clickyab/gad-runner
        command: /app/bin/impworker
        state: started
        restart_policy: always
        recreate: yes
        volumes:
          - /home/cy/gad:/app

- name: Run conv worker
  hosts: conv
  tasks:

    - name: Re-create conv worker
      docker_container:
        name: gad-conv
        image: registry.clickyab.ae/clickyab/gad-runner
        command: /app/bin/convworker
        state: started
        restart_policy: always
        recreate: yes
        volumes:
          - /home/cy/gad:/app

- name: Run warn worker
  hosts: warn
  tasks:

    - name: Re-create warn worker
      docker_container:
        name: gad-warn
        image: registry.clickyab.ae/clickyab/gad-runner
        command: /app/bin/warnworker
        state: started
        restart_policy: always
        recreate: yes
        volumes:
          - /home/cy/gad:/app

